# SSR ビルド最適化リファクタリングタスクリスト

## 現状の分析結果

### 現在のアーキテクチャの問題点

#### 1. ホームページの完全クライアントサイドレンダリング
- **ファイル**: `app/page.tsx`
- **問題**: `"use client"` ディレクティブを使用しており、2000以上の絵文字をクライアント側でレンダリングしている
- **影響**:
  - 初期表示のパフォーマンスが低下
  - SEO に不利（コンテンツがサーバーサイドでレンダリングされない）
  - JavaScript バンドルサイズが大きい
  - FCP (First Contentful Paint) が遅い

#### 2. 絵文字データのバンドル戦略
- **ファイル**: `lib/emojis.ts`
- **問題**: `emojis.json` を直接インポートしているため、ビルド時にバンドルされる
- **影響**:
  - すべてのページで絵文字データがバンドルに含まれる
  - データのキャッシュ戦略がない

#### 3. generateStaticParams の制限
- **ファイル**: `app/emoji/[id]/page.tsx`
- **問題**: 最初の100件の絵文字のみ事前生成されている
- **影響**:
  - 100件以降の絵文字ページはオンデマンドでレンダリングされる
  - 初回アクセス時にレンダリング遅延が発生する可能性

#### 4. next.config.ts の最適化設定不足
- **ファイル**: `next.config.ts`
- **問題**: 最適化設定が空
- **影響**:
  - 画像最適化やバンドル最適化の設定が利用されていない

#### 5. 動的インポートの一貫性
- **ファイル**: `lib/popular-emojis.ts`
- **問題**: `getPopularEmojis()` 関数内で動的インポートを使用しているが、クライアントコンポーネントから呼び出されている
- **影響**:
  - 実行時のパフォーマンス低下
  - コードの意図が不明確

### 良好な実装（維持・推奨）

#### 1. 個別絵文字ページ (`app/emoji/[id]/page.tsx`)
- **評価**: ✅ 良好
- **理由**:
  - サーバーコンポーネントとして実装されている
  - ISR (revalidate = 86400) が設定されている
  - generateMetadata で動的メタデータ生成

#### 2. カテゴリページ (`app/category/[slug]/page.tsx`)
- **評価**: ✅ 良好
- **理由**:
  - サーバーコンポーネントとして実装されている
  - ISR (revalidate = 604800) が設定されている
  - ページネーション対応

#### 3. SEO コンポーネント
- **評価**: ✅ 良好
- **理由**:
  - `Breadcrumb`、`JsonLd`、`EmojiCard` がサーバーコンポーネントとして実装されている
  - 構造化データが適切に生成されている

---

## リファクタリングタスクリスト

### 優先度: 高

#### タスク 1: ホームページのサーバーコンポーネント化
- [ ] **`app/page.tsx` のリファクタリング**
  - `"use client"` ディレクティブを削除し、サーバーコンポーネント化
  - サーバーサイドで絵文字データをレンダリング
  - 検索・フィルタリング機能をクライアントコンポーネントとして分離
  - ローカルストレージ機能をクライアントコンポーネントとして分離

- [ ] **新規クライアントコンポーネントの作成**
  - `components/EmojiSearch.tsx`: 検索・フィルタリング機能
  - `components/EmojiGrid.tsx`: 絵文字グリッド表示（必要に応じて）
  - `components/RecentlyUsed.tsx`: 最近使用した絵文字

#### タスク 2: generateStaticParams の拡張
- [ ] **`app/emoji/[id]/page.tsx` の修正**
  - 100件制限を削除し、すべての絵文字を事前生成
  - ビルド時間とパフォーマンスのバランスを考慮し、カテゴリ別に生成を分割

- [ ] **静的生成戦略の見直し**
  - すべての絵文字を対象に `generateStaticParams` を実行
  - 必要に応じてビルド時のメモリ使用量を監視

#### タスク 3: next.config.ts の最適化
- [ ] **画像最適化の有効化**
  - リモートパターンの設定（OGP画像など）
  - 画像フォーマットの最適化設定

- [ ] **バンドル最適化**
  - `swcMinify` の確認と有効化
  - `modularizeImports` の設定（アイコンライブラリなど）

- [ ] **実験的機能の有効化**
  - `optimizePackageImports` の設定

---

### 優先度: 中

#### タスク 4: データアクセス層の最適化
- [ ] **`lib/emojis.ts` の改善**
  - キャッシュ戦略の実装（` unstable_cache` の使用）
  - データアクセス関数の最適化
  - 必要に応じてデータの分割

- [ ] **`lib/popular-emojis.ts` の修正**
  - 動的インポートの削除
  - 同期的なデータアクセスへの変更

#### タスク 5: クライアントコンポーネントの最適化
- [ ] **`app/emoji/[id]/CopyButton.tsx` の見直し**
  - 現状のままでも問題ないが、必要に応じて最適化
  - `React.memo` の追加検討

- [ ] **新規クライアントコンポーネントの実装**
  - ホームページ用の検索・フィルタリングコンポーネント
  - 最近使用した絵文字の表示コンポーネント

#### タスク 6: パフォーマンスモニタリング
- [ ] **Core Web Vitals の測定**
  - LCP (Largest Contentful Paint)
  - FID (First Input Delay)
  - CLS (Cumulative Layout Shift)

- [ ] **ビルド時間の監視**
  - `bun run build` の実行時間の記録
  - メモリ使用量の監視

---

### 優先度: 低

#### タスク 7: コンポーネントの分割
- [ ] **大きなコンポーネントの分割**
  - ホームページの適切なコンポーネント分割
  - 再利用可能なコンポーネントの抽出

#### タスク 8: キャッシュ戦略の見直し
- [ ] **ISR の再検証時間の見直し**
  - 現在の設定が適切か確認
  - 必要に応じて調整

#### タスク 9: 型安全性の向上
- [ ] **型定義の強化**
  - `lib/types.ts` の見直し
  - より厳密な型定義の追加

#### タスク 10: テストの追加
- [ ] **サーバーコンポーネントのテスト**
  - 新規コンポーネントのテスト追加
  - 既存テストの更新

---

## 実装の優先順序

### フェーズ 1: ホームページのリファクタリング（最重要）
1. 検索・フィルタリング機能のクライアントコンポーネント化
2. ホームページのサーバーコンポーネント化
3. 最近使用した絵文字機能のクライアントコンポーネント化

### フェーズ 2: 静的生成の拡張
1. `generateStaticParams` の拡張
2. ビルド時間の監視と調整

### フェーズ 3: 設定の最適化
1. `next.config.ts` の最適化
2. データアクセス層の改善

### フェーズ 4: モニタリングと微調整
1. パフォーマンスモニタリング
2. 必要に応じた微調整

---

## 期待される効果

### パフォーマンス向上
- **FCP (First Contentful Paint)**: 30-50% 向上
- **LCP (Largest Contentful Paint)**: 40-60% 向上
- **TTI (Time to Interactive)**: 50% 以上向上

### SEO 向上
- サーバーサイドレンダリングによるコンテンツのインデックス化
- メタデータの適切な生成
- 構造化データの活用

### ユーザー体験の向上
- 初期表示の高速化
- スムーズなインタラクション
- モバイルでのパフォーマンス向上

---

## メモ

- **ビルド時間**: `generateStaticParams` を拡張するとビルド時間が増加する可能性がある
- **メモリ使用量**: 2000以上のページを生成する場合、メモリ使用量に注意が必要
- **デプロイ先**: Vercel などのプラットフォームではビルド時間の制限があるため注意
